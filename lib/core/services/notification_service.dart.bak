import 'package:flutter_local_notifications/flutter_local_notifications.dart';import 'package:flutter_local_notifications/flutter_local_notifications.dart';

import 'package:flutter/material.dart';import 'package:flutter/material.dart';

import '../../features/daily_activities/models/event.dart';import '../../features/daily_activities/models/event.dart';



class NotificationService {class NotificationService {

  static final NotificationService _instance = NotificationService._internal();  static final NotificationService _instance = NotificationService._internal();

  factory NotificationService() => _instance;  factory NotificationService() => _instance;

    

  static const String _channelId = 'default_channel';  static const String _channelId = 'default_channel';

  static const String _channelName = 'Default Channel';  static const String _channelName = 'Default Channel';

  static const String _channelDescription = 'Default notification channel';  static const String _channelDescription = 'Default notification channel';

    

  final _flutterLocalNotificationsPlugin = FlutterLocalNotificationsPlugin();  final _flutterLocalNotificationsPlugin = FlutterLocalNotificationsPlugin();



  NotificationService._internal() {  NotificationService._internal() {

    _init();    _init();

  }  }



  Future<void> _init() async {  Future<void> _init() async {

    // Configure platform-specific settings    // Configure platform-specific settings

    const androidSettings = AndroidInitializationSettings('@mipmap/ic_launcher');    const androidSettings = AndroidInitializationSettings('@mipmap/ic_launcher');

    const iosSettings = DarwinInitializationSettings();    const iosSettings = DarwinInitializationSettings();

    const initSettings = InitializationSettings(android: androidSettings, iOS: iosSettings);    const initSettings = InitializationSettings(android: androidSettings, iOS: iosSettings);



    await _flutterLocalNotificationsPlugin.initialize(    await _flutterLocalNotificationsPlugin.initialize(

      initSettings,      initSettings,

      onDidReceiveNotificationResponse: _onDidReceiveNotificationResponse,      onDidReceiveNotificationResponse: _onDidReceiveNotificationResponse,

    );    );



    // Create notification channel for Android with proper importance    // Create notification channel for Android with proper importance

    const AndroidNotificationChannel channel = AndroidNotificationChannel(    const AndroidNotificationChannel channel = AndroidNotificationChannel(

      _channelId,      _channelId,

      _channelName,      _channelName,

      description: _channelDescription,      description: _channelDescription,

      importance: Importance.high,      importance: Importance.high,

      enableLights: true,      enableLights: true,

      enableVibration: true,      enableVibration: true,

      playSound: true,      playSound: true,

    );    );



    await _flutterLocalNotificationsPlugin    await _flutterLocalNotificationsPlugin

        .resolvePlatformSpecificImplementation<        .resolvePlatformSpecificImplementation<

            AndroidFlutterLocalNotificationsPlugin>()            AndroidFlutterLocalNotificationsPlugin>()

        ?.createNotificationChannel(channel);        ?.createNotificationChannel(channel);



    // Request permissions    // Request permissions

    await requestPermissions();    await requestPermissions();

  }  }



  void _onDidReceiveNotificationResponse(NotificationResponse notificationResponse) {  void _onDidReceiveNotificationResponse(NotificationResponse notificationResponse) {

    // Handle notification tap    // Handle notification tap

    final String? payload = notificationResponse.payload;    final String? payload = notificationResponse.payload;

    if (payload != null) {    if (payload != null) {

      debugPrint('Notification tapped with payload: $payload');      debugPrint('Notification tapped with payload: $payload');

    }    }

  }  }



  Future<void> showNotification(String title, String body, {String? payload}) async {  Future<void> showNotification(String title, String body, {String? payload}) async {

    const notificationDetails = NotificationDetails(    const notificationDetails = NotificationDetails(

      android: AndroidNotificationDetails(      android: AndroidNotificationDetails(

        _channelId,        _channelId,

        _channelName,        _channelName,

        importance: Importance.high,        importance: Importance.high,

        priority: Priority.high,        priority: Priority.high,

      ),      ),

      iOS: DarwinNotificationDetails(      iOS: DarwinNotificationDetails(

        presentAlert: true,        presentAlert: true,

        presentBadge: true,        presentBadge: true,

        presentSound: true,        presentSound: true,

      ),      ),

    );    );



    await _flutterLocalNotificationsPlugin.show(    await _flutterLocalNotificationsPlugin.show(

      0,      0,

      title,      title,

      body,      body,

      notificationDetails,      notificationDetails,

      payload: payload,      payload: payload,

    );    );

  }  }



  Future<void> notifyEventCompletion(Event event) async {  Future<void> notifyEventCompletion(Event event) async {

    await showNotification(    await showNotification(

      'Event Completed',      'Event Completed',

      '${event.title} has been marked as completed',      '${event.title} has been marked as completed',

      payload: 'event:${event.id}',      payload: 'event:${event.id}',

    );    );

  }  }



  Future<void> showEventReminderNotification(Event event) async {  Future<void> showEventReminderNotification(Event event) async {

    await showNotification(    await showNotification(

      'Upcoming Event',      'Upcoming Event',

      '${event.title} is starting soon',      '${event.title} is starting soon',

      payload: 'event_reminder:${event.id}',      payload: 'event_reminder:${event.id}',

    );    );

  }  }



  // Request permissions for notifications  // Request permissions for notifications

  Future<bool> requestPermissions() async {  Future<bool> requestPermissions() async {

    // Request iOS permissions    // Request iOS permissions

    final bool? iosGranted = await _flutterLocalNotificationsPlugin    final bool? iosGranted = await _flutterLocalNotificationsPlugin

        .resolvePlatformSpecificImplementation<        .resolvePlatformSpecificImplementation<

            IOSFlutterLocalNotificationsPlugin>()            IOSFlutterLocalNotificationsPlugin>()

        ?.requestPermissions(        ?.requestPermissions(

          alert: true,          alert: true,

          badge: true,          badge: true,

          sound: true,          sound: true,

        );        );



    // Request Android permissions    // Request Android permissions

    final bool? androidGranted = await _flutterLocalNotificationsPlugin    final bool? androidGranted = await _flutterLocalNotificationsPlugin

        .resolvePlatformSpecificImplementation<        .resolvePlatformSpecificImplementation<

            AndroidFlutterLocalNotificationsPlugin>()            AndroidFlutterLocalNotificationsPlugin>()

        ?.requestNotificationsPermission();        ?.requestNotificationsPermission();



    return (iosGranted ?? true) && (androidGranted ?? true);    return iosGranted ?? true && androidGranted ?? true;

  }  }

}

  /// Schedule event notifications: 5 minutes before and at start time

  Future<void> scheduleEventNotifications(Event event) async {

    final now = DateTime.now();

  void _onDidReceiveNotificationResponse(

    // Schedule 5-minute reminder (only if event is more than 5 minutes away)    NotificationResponse notificationResponse,

    final fiveMinutesBefore = event.startTime.subtract(  ) {

      const Duration(minutes: 5),    // Handle notification tap

    );    final String? payload = notificationResponse.payload;

    if (fiveMinutesBefore.isAfter(now)) {    if (payload != null) {

      await showNotification(      // You can navigate to specific screens based on payload

        'Event Starting Soon!',      // TODO: Implement navigation logic based on payload

        '"${event.title}" starts in 5 minutes',    }

        payload: 'event_reminder:${event.id}',  }

      );

    }  /// Schedule event notifications: 5 minutes before and at start time

  Future<void> scheduleEventNotifications(Event event) async {

    // Schedule start notification    final now = DateTime.now();

    if (event.startTime.isAfter(now)) {

      await showNotification(    // Schedule 5-minute reminder (only if event is more than 5 minutes away)

        'Event Started',    final fiveMinutesBefore = event.startTime.subtract(

        '"${event.title}" is starting now',      const Duration(minutes: 5),

        payload: 'event_start:${event.id}',    );

      );    if (fiveMinutesBefore.isAfter(now)) {

    }      await showNotification(

  }        'Event Starting Soon!',

        '"${event.title}" starts in 5 minutes',

  /// Cancel all notifications        payload: 'event_reminder:${event.id}',

  Future<void> cancelAllNotifications() async {      );

    await _flutterLocalNotificationsPlugin.cancelAll();    }

  }

}    // Schedule start notification
    if (event.startTime.isAfter(now)) {
      await showNotification(
        'Event Started',
        '"${event.title}" is starting now',
        payload: 'event_start:${event.id}',
      );
    }
  }

  /// Cancel all notifications
  Future<void> cancelAllNotifications() async {
    await _flutterLocalNotificationsPlugin.cancelAll();
  }
}
